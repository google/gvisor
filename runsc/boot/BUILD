load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

package(licenses = ["notice"])

go_library(
    name = "boot",
    srcs = [
        "compat.go",
        "compat_amd64.go",
        "config.go",
        "controller.go",
        "debug.go",
        "events.go",
        "fds.go",
        "fs.go",
        "limits.go",
        "loader.go",
        "loader_amd64.go",
        "loader_arm64.go",
        "network.go",
        "pprof.go",
        "strace.go",
        "user.go",
    ],
    importpath = "gvisor.dev/gvisor/runsc/boot",
    visibility = [
        "//runsc:__subpackages__",
        "//test:__subpackages__",
    ],
    deps = [
        "//pkg/abi",
        "//pkg/abi/linux",
        "//pkg/control/server",
        "//pkg/cpuid",
        "//pkg/eventchannel",
        "//pkg/log",
        "//pkg/memutil",
        "//pkg/rand",
        "//pkg/refs",
        "//pkg/sentry/arch",
        "//pkg/sentry/arch:registers_go_proto",
        "//pkg/sentry/context",
        "//pkg/sentry/control",
        "//pkg/sentry/fs",
        "//pkg/sentry/fs/dev",
        "//pkg/sentry/fs/gofer",
        "//pkg/sentry/fs/host",
        "//pkg/sentry/fs/proc",
        "//pkg/sentry/fs/ramfs",
        "//pkg/sentry/fs/sys",
        "//pkg/sentry/fs/tmpfs",
        "//pkg/sentry/fs/tty",
        "//pkg/sentry/inet",
        "//pkg/sentry/kernel",
        "//pkg/sentry/kernel:uncaught_signal_go_proto",
        "//pkg/sentry/kernel/auth",
        "//pkg/sentry/limits",
        "//pkg/sentry/loader",
        "//pkg/sentry/pgalloc",
        "//pkg/sentry/platform",
        "//pkg/sentry/sighandling",
        "//pkg/sentry/socket/hostinet",
        "//pkg/sentry/socket/netlink",
        "//pkg/sentry/socket/netlink/route",
        "//pkg/sentry/socket/netlink/uevent",
        "//pkg/sentry/socket/netstack",
        "//pkg/sentry/socket/unix",
        "//pkg/sentry/state",
        "//pkg/sentry/strace",
        "//pkg/sentry/syscalls/linux",
        "//pkg/sentry/time",
        "//pkg/sentry/unimpl:unimplemented_syscall_go_proto",
        "//pkg/sentry/usage",
        "//pkg/sentry/usermem",
        "//pkg/sentry/watchdog",
        "//pkg/syserror",
        "//pkg/tcpip",
        "//pkg/tcpip/link/fdbased",
        "//pkg/tcpip/link/loopback",
        "//pkg/tcpip/link/sniffer",
        "//pkg/tcpip/network/arp",
        "//pkg/tcpip/network/ipv4",
        "//pkg/tcpip/network/ipv6",
        "//pkg/tcpip/stack",
        "//pkg/tcpip/transport/icmp",
        "//pkg/tcpip/transport/raw",
        "//pkg/tcpip/transport/tcp",
        "//pkg/tcpip/transport/udp",
        "//pkg/urpc",
        "//runsc/boot/filter",
        "//runsc/boot/platforms",
        "//runsc/specutils",
        "@com_github_golang_protobuf//proto:go_default_library",
        "@com_github_opencontainers_runtime-spec//specs-go:go_default_library",
        "@org_golang_x_sys//unix:go_default_library",
    ],
)

go_test(
    name = "boot_test",
    size = "small",
    srcs = [
        "compat_test.go",
        "fs_test.go",
        "loader_test.go",
        "user_test.go",
    ],
    embed = [":boot"],
    deps = [
        "//pkg/control/server",
        "//pkg/log",
        "//pkg/p9",
        "//pkg/sentry/arch:registers_go_proto",
        "//pkg/sentry/context/contexttest",
        "//pkg/sentry/fs",
        "//pkg/sentry/kernel/auth",
        "//pkg/unet",
        "//runsc/fsgofer",
        "@com_github_opencontainers_runtime-spec//specs-go:go_default_library",
    ],
)
